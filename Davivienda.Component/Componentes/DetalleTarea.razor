@namespace Davivienda.Component.Componentes
@using Davivienda.Models.Modelos
@using Davivienda.GraphQL.SDK

<div class="detalle-tarea-fullscreen">
    @* --- TOOLBAR PREMIUM --- *@
    <div class="toolbar-dav animate-slide-down">
        <div class="header-main-info">
            <h2 class="main-page-title">Gestión de Tarea: <span class="text-wine">@Tarea?.TAR_NOM</span></h2>
        </div>

        <div class="toolbar-actions">
            <div class="selector-container-premium">
                <i class="fas fa-history icon-blue"></i>
                <label>VER HISTORIAL:</label>
                <select class="select-dav-mini" @onchange="ManejarCambioBitacora" id="sel_bitacora_global">
                    <option value="">-- Seleccionar --</option>
                    <option value="BIT_SOL">Bitácora de Soluciones</option>
                    <option value="BIT_FRI">Bitácora de Fricciones</option>
                </select>
            </div>
            <button class="btn-close-dav-pill" @onclick="Cerrar" id="btn_cerrar_detalle_fullscreen">
                CERRAR DETALLE <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="main-grid-container">
        @* --- LADO IZQUIERDO --- *@
        <div class="side-stack">
            @* Cuadrante 1: Info General *@
            <div class="quadrant-card border-accent-wine">
                <div class="card-header-premium bg-wine-soft">
                    <div class="header-left">
                        <i class="fas fa-info-circle icon-wine"></i>
                        <h4>Información General</h4>
                    </div>
                </div>
                <div class="card-body-premium scroll-dav bg-warm-white">
                    <h3 class="task-title-display">@Tarea?.TAR_NOM</h3>
                    <div class="status-pill-row">
                        <span class="label-tiny">ESTADO ACTUAL</span>
                        <span class="badge-status-premium">@Tarea?.TAR_EST</span>
                    </div>
                </div>
            </div>

            @* Cuadrante 2: Comentarios *@
            <div class="quadrant-card border-accent-green">
                <div class="card-header-premium bg-green-soft">
                    <div class="header-left">
                        <i class="fas fa-comments icon-green"></i>
                        <h4>Comentarios / Notas</h4>
                    </div>
                </div>
                <div class="card-body-premium scroll-dav no-padding bg-warm-white">
                    <div class="yoopta-wrapper">
                        <Yoopta></Yoopta>
                    </div>
                </div>
            </div>
        </div>

        @* --- LADO DERECHO --- *@
        <div class="side-stack">
            @* Cuadrante 3: Soluciones *@
            <div class="quadrant-card border-accent-blue">
                <div class="card-header-premium bg-blue-soft">
                    <div class="header-left">
                        <i class="fas fa-lightbulb icon-blue"></i>
                        <h4>Soluciones Propuestas</h4>
                    </div>
                    @* BOTÓN CORREGIDO: Visible y estilizado *@
                    <button class="btn-add-mini-pill add-blue" @onclick="AbrirModalCrearSolucion" id="btn_crear_solucion_quadrant">
                        <i class="fas fa-plus"></i> CREAR
                    </button>
                </div>
                <div class="card-body-premium scroll-dav bg-warm-white">
                    @if (SolucionesList?.Any() == true)
                    {
                        @foreach (var sol in SolucionesList)
                        {
                            <div class="item-card-mini" @onclick="() => AbrirModalEditarSolucion(sol)">
                                <div class="item-top-row">
                                    <span class="item-name">@sol.SOL_NOM</span>
                                    <span class="item-tag tag-blue">@sol.SOL_EST</span>
                                </div>
                                <p class="item-desc">@sol.SOL_DES</p>
                                <button class="btn-item-delete" @onclick:stopPropagation @onclick="() => EliminarSolucion(sol.SOL_ID)">
                                    <i class="fas fa-trash-alt"></i> ELIMINAR
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            @* Cuadrante 4: Fricciones *@
            <div class="quadrant-card border-accent-gold">
                <div class="card-header-premium bg-gold-soft">
                    <div class="header-left">
                        <i class="fas fa-exclamation-triangle icon-gold"></i>
                        <h4>Fricciones Detectadas</h4>
                    </div>
                    @* BOTÓN CORREGIDO: Visible y estilizado *@
                    <button class="btn-add-mini-pill add-gold" @onclick="AbrirModalCrearFriccion" id="btn_crear_friccion_quadrant">
                        <i class="fas fa-plus"></i> CREAR
                    </button>
                </div>
                <div class="card-body-premium scroll-dav bg-warm-white">
                    @if (FriccionesList?.Any() == true)
                    {
                        @foreach (var fri in FriccionesList)
                        {
                            <div class="item-card-mini" @onclick="() => AbrirModalEditarFriccion(fri)">
                                <div class="item-top-row">
                                    <span class="item-name">@fri.FRI_TIP</span>
                                    <span class="item-tag tag-gold">@fri.FRI_IMP</span>
                                </div>
                                <p class="item-desc">@fri.FRI_DES</p>
                                <button class="btn-item-delete" @onclick:stopPropagation @onclick="() => EliminarFriccion(fri.FRI_ID)">
                                    <i class="fas fa-trash-alt"></i> ELIMINAR
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@* --- MODAL INTEGRADO CORREGIDO (LÓGICA DE CIERRE) --- *@
@if (MostrarModalCrear)
{
    <div class="modal-backdrop-premium" @onclick="CerrarModalInterno">
        <div class="modal-window-dav @(TipoModal.StartsWith("HISTORIAL") ? "size-xl" : "size-md")" @onclick:stopPropagation>
            <div class="modal-header-dav">
                <h3>@TituloModal</h3>
                <button class="modal-close-x" @onclick="CerrarModalInterno" id="btn_x_cerrar_modal_detalle">×</button>
            </div>
            <div class="modal-body-dav scroll-dav">
                @* Se añade OnClose a cada componente hijo para habilitar el cierre *@
                @if (TipoModal == "FRICCION_NUEVA" && Tarea != null)
                {
                    <CrearFriccion TareaId="@Tarea.TAR_ID" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                }

                else if (TipoModal == "SOLUCION_NUEVA")
                {

                    <CrearSolucion FriccionId="@(FriccionesList?.FirstOrDefault()?.FRI_ID ?? Guid.Empty)" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                }

                else if (TipoModal == "HISTORIAL_SOLUCIONES")
                {

                    <BitacoraSolucion />
                }
                else if (TipoModal == "HISTORIAL_FRICCIONES")
                {

                    <BitacoraFriccion />
                }
            </div>
        </div>
    </div>
}