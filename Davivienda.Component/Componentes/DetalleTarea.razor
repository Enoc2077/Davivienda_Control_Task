@namespace Davivienda.Component.Componentes
@using Davivienda.Models.Modelos
@using Davivienda.GraphQL.SDK

<div class="modal-fullscreen-overlay">
    @* --- TOOLBAR SUPERIOR --- *@
    <div class="toolbar-dav-top">
        <div class="toolbar-actions">
            <div class="selector-container-premium">
                <i class="fas fa-history icon-blue"></i>
                <label>Gestión de Tareas</label>
                <label>Ver Historial:</label>
                <select class="select-dav-mini" @onchange="ManejarCambioBitacora">
                    <option value="">-- Seleccionar --</option>
                    <option value="BIT_SOL">Bitácora de Soluciones</option>
                    <option value="BIT_FRI">Bitácora de Fricciones</option>
                </select>
            </div>
            <button type="button" class="btn-close-fullscreen" @onclick="Cerrar">×</button>
        </div>
    </div>

    <div class="modal-content-container">
        @* SECTOR 1: INFORMACIÓN DE EJECUCIÓN (CUADRANTE SUPERIOR) *@
        <div class="sector sector-1">
            <div class="sector-accent-line"></div>
            <div class="sector-header">
                <div class="title-group">
                    <h3 class="sector-title">@Tarea?.TAR_NOM</h3>
                    <span class="sector-subtitle">Información de Ejecución</span>
                </div>
                <button type="button" class="btn-save-top-right" @onclick="GuardarEstadoTarea">
                    <i class="fas fa-save"></i> GUARDAR
                </button>
            </div>

            <div class="sector-content">
                <div class="info-execution-grid">
                    @* Visualización del Proyecto *@
                    <div class="info-item">
                        <span class="label-tiny">PROYECTO ASOCIADO</span>
                        <p class="value-text highlight-blue">@NombreProyecto</p>
                    </div>

                    @* Visualización del Proceso *@
                    <div class="info-item">
                        <span class="label-tiny">PROCESO ACTUAL</span>
                        <p class="value-text highlight-dark">@NombreProceso</p>
                    </div>

                    @if (Tarea != null)
                    {
                        <div class="status-editor">
                            <label class="label-tiny">ACTUALIZAR ESTADO</label>
                            <select @bind="Tarea.TAR_EST" class="select-status-dav">
                                <option value="Pendiente">Pendiente</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="Completado">Completado</option>
                            </select>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* SECTOR 2: NOTAS *@
        <div class="sector sector-2">
            <div class="sector-accent-line"></div>
            <div class="sector-icon"><i class="fas fa-comments"></i></div>
            <div class="sector-header">
                <h3 class="sector-title">Notas</h3>
                <span class="sector-subtitle">Comentarios de Equipo</span>
            </div>
            <div class="sector-content"><div class="yoopta-wrapper"><Yoopta /></div></div>
        </div>

        @* SECTOR 3: SOLUCIONES *@
        <div class="sector sector-3">
            <div class="sector-accent-line"></div>
            <div class="sector-header">
                <div class="title-group">
                    <h3 class="sector-title">Soluciones</h3>
                    <span class="sector-subtitle">Propuestas Activas</span>
                </div>
                <button type="button" class="btn-add-mini-pill" @onclick="AbrirModalCrearSolucion" title="Añadir Solución">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="sector-content scroll-dav">
                @if (SolucionesList?.Any() == true)
                {
                    @foreach (var sol in SolucionesList)
                    {
                        <div class="item-card-mini" @onclick="() => AbrirModalEditarSolucion(sol)">
                            <span>@sol.SOL_NOM</span>
                            <button type="button" class="btn-del"
                                    @onclick:stopPropagation
                                    @onclick="() => EliminarSolucion(sol.SOL_ID)">
                                ×
                            </button>
                        </div>
                    }
                }
            </div>
        </div>

        @* SECTOR 4: FRICCIONES *@
        <div class="sector sector-4">
            <div class="sector-accent-line"></div>
            <div class="sector-header">
                <div class="title-group">
                    <h3 class="sector-title">Fricciones</h3>
                    <span class="sector-subtitle">Obstáculos Detectados</span>
                </div>
                <button type="button" class="btn-add-mini-pill" @onclick="AbrirModalCrearFriccion" title="Reportar Fricción">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="sector-content scroll-dav">
                @if (FriccionesList?.Any() == true)
                {
                    @foreach (var fri in FriccionesList)
                    {
                        <div class="item-card-mini" @onclick="() => AbrirModalEditarFriccion(fri)">
                            <span>@fri.FRI_TIP</span>
                            <button type="button" class="btn-del"
                                    @onclick:stopPropagation
                                    @onclick="() => EliminarFriccion(fri.FRI_ID)">
                                ×
                            </button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @* --- MODALES INTERNOS --- *@
    @if (MostrarModalCrear)
    {
        <div class="modal-backdrop-premium" @onclick="CerrarModalInterno">
            <div class="modal-window-dav @(TipoModal.StartsWith("HISTORIAL") ? "size-xl" : "size-md")" @onclick:stopPropagation>
                <div class="modal-header-dav">
                    <h3>@TituloModal</h3>
                    <button type="button" class="modal-close-x" @onclick="CerrarModalInterno">×</button>
                </div>
                <div class="modal-body-dav">
                    @if (TipoModal == "FRICCION_NUEVA" && Tarea != null)
                    {
                        <CrearFriccion TareaId="@Tarea.TAR_ID" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                    }
                    else if (TipoModal == "SOLUCION_NUEVA")
                    {
                        <CrearSolucion FriccionId="@(FriccionesList?.FirstOrDefault()?.FRI_ID ?? Guid.Empty)" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                    }
                    else if (TipoModal == "SOLUCION_EDITAR" && SolucionSeleccionada != null)
                    {
                        <EditarSolucion Solucion="@SolucionSeleccionada" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                    }
                    else if (TipoModal == "FRICCION_EDITAR" && FriccionSeleccionada != null)
                    {
                        <Davivienda.Componentes.EditarFriccion Friccion="@FriccionSeleccionada" OnSuccess="AlCrearExitoso" OnClose="CerrarModalInterno" />
                    }
                    else if (TipoModal == "HISTORIAL_SOLUCIONES")
                    {
                        <BitacoraSolucion OnClose="CerrarModalInterno" />
                    }
                    else if (TipoModal == "HISTORIAL_FRICCIONES")
                    {
                        <BitacoraFriccion OnClose="CerrarModalInterno" />
                    }
                </div>
            </div>
        </div>
    }
</div>